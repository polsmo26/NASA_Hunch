<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA HUNCH - Medical Diagnosis System</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .nasa-header {
            background: linear-gradient(90deg, #0b3d91 0%, #1c6fd6 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-bottom: 5px solid #e83f4e;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .symptom-category {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #0b3d91;
        }
        
        .symptom-option {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .symptom-option:hover {
            background: #e3f2fd;
            border-color: #0d6efd;
        }
        
        .symptom-option.selected {
            background: #0d6efd;
            color: white;
            border-color: #0a58ca;
        }
        
        .symptom-option.selected .symptom-icon {
            color: white;
        }
        
        .symptom-icon {
            font-size: 1.2rem;
            margin-right: 12px;
            color: #0b3d91;
        }
        
        .flow-step {
            display: none;
        }
        
        .flow-step.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .severity-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .progress {
            height: 10px;
            border-radius: 5px;
        }
        
        .treatment-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }
        
        .emergency-alert {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(238, 90, 82, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(238, 90, 82, 0); }
            100% { box-shadow: 0 0 0 0 rgba(238, 90, 82, 0); }
        }
        
        .nav-btn {
            padding: 10px 30px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .selected-count {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- NASA Header -->
    <div class="nasa-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-1">
                    <div style="font-size: 3rem;">üöÄ</div>
                </div>
                <div class="col-md-11">
                    <h1 class="display-5 fw-bold">NASA HUNCH Medical System</h1>
                    <p class="lead mb-0">AI-Powered Symptom Analysis & Diagnosis for Space and Earth</p>
                    <small>Developed by NASA HUNCH Student Team</small>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Step 1: Initial Symptoms -->
        <div class="flow-step active" id="step1">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-clipboard-pulse"></i> Step 1: What's bothering you most?</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">Select your main symptom(s) to begin. You'll be able to add more details in the next steps.</p>
                    
                    <!-- Quick Selection -->
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="symptom-option" data-symptom="fever">
                                <i class="bi bi-thermometer-sun symptom-icon"></i>
                                <div>
                                    <strong>Fever</strong>
                                    <div class="text-muted small">Elevated body temperature</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="symptom-option" data-symptom="cough">
                                <i class="bi bi-lungs symptom-icon"></i>
                                <div>
                                    <strong>Cough</strong>
                                    <div class="text-muted small">Persistent coughing</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="symptom-option" data-symptom="headache">
                                <i class="bi bi-emoji-dizzy symptom-icon"></i>
                                <div>
                                    <strong>Headache</strong>
                                    <div class="text-muted small">Head pain or pressure</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="symptom-option" data-symptom="fatigue">
                                <i class="bi bi-battery-half symptom-icon"></i>
                                <div>
                                    <strong>Fatigue</strong>
                                    <div class="text-muted small">Extreme tiredness</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="symptom-option" data-symptom="nausea">
                                <i class="bi bi-emoji-sick symptom-icon"></i>
                                <div>
                                    <strong>Nausea</strong>
                                    <div class="text-muted small">Feeling sick to stomach</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="symptom-option" data-symptom="chest pain">
                                <i class="bi bi-heart-pulse symptom-icon"></i>
                                <div>
                                    <strong>Chest Pain</strong>
                                    <div class="text-muted small">Chest discomfort</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Or Search/Add -->
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6><i class="bi bi-search"></i> Can't find your symptom?</h6>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="symptomSearch" placeholder="Search for symptoms like 'sore throat', 'rash', 'dizziness'...">
                                <button class="btn btn-outline-primary" id="addSymptomBtn">Add</button>
                            </div>
                            <div id="searchResults" class="mt-2"></div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <div></div>
                        <button class="btn btn-primary nav-btn" onclick="nextStep(2)">
                            Next <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Symptom Details -->
        <div class="flow-step" id="step2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-clipboard-data"></i> Step 2: Tell us more about your symptoms</h4>
                </div>
                <div class="card-body">
                    <div id="symptomDetailsContainer">
                        <!-- Dynamic content for each selected symptom -->
                        <p class="text-muted">No symptoms selected yet. Go back to Step 1.</p>
                    </div>
                    
                    <!-- Suggested Symptoms based on current selection -->
                    <div class="card bg-light mt-4" id="suggestedSymptomsCard" style="display: none;">
                        <div class="card-body">
                            <h6><i class="bi bi-lightbulb"></i> You might also be experiencing:</h6>
                            <div id="suggestedSymptoms" class="d-flex flex-wrap gap-2 mt-2"></div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-secondary nav-btn" onclick="prevStep(1)">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                        <button class="btn btn-primary nav-btn" onclick="nextStep(3)">
                            Next <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Patient Info & History -->
        <div class="flow-step" id="step3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-person"></i> Step 3: Patient Information</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Age</label>
                            <input type="number" class="form-control" id="patientAge" min="0" max="120" placeholder="Your age">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Gender</label>
                            <select class="form-select" id="patientGender">
                                <option selected>Select gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other/Prefer not to say</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">Any known medical conditions?</label>
                        <textarea class="form-control" id="medicalHistory" rows="3" placeholder="e.g., Diabetes, Asthma, High Blood Pressure..."></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">Duration of symptoms</label>
                        <select class="form-select" id="symptomDuration">
                            <option selected>Select duration</option>
                            <option value="hours">Less than 24 hours</option>
                            <option value="days_1_3">1-3 days</option>
                            <option value="days_4_7">4-7 days</option>
                            <option value="weeks_1_2">1-2 weeks</option>
                            <option value="weeks_2plus">More than 2 weeks</option>
                        </select>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-secondary nav-btn" onclick="prevStep(2)">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                        <button class="btn btn-success nav-btn" onclick="getDiagnosis()">
                            <i class="bi bi-stethoscope"></i> Get Diagnosis
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="flow-step" id="step4">
            <div class="result-card">
                <!-- Loading -->
                <div id="loadingSection" style="display: none;">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h4 class="mt-4">NASA AI Engine Analyzing Symptoms...</h4>
                        <p class="text-muted">Comparing with 770+ diseases and 46,000+ medical cases</p>
                    </div>
                </div>
                
                <!-- Results -->
                <div id="resultsSection" style="display: none;">
                    <div class="text-center mb-4">
                        <h2 class="text-primary">Diagnosis Results</h2>
                        <p class="text-muted">Based on NASA HUNCH Medical AI Analysis</p>
                    </div>
                    
                    <!-- Emergency Alert (if needed) -->
                    <div id="emergencyAlert" class="emergency-alert" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
                            <div>
                                <h5 class="mb-1">‚ö†Ô∏è EMERGENCY WARNING</h5>
                                <p class="mb-0" id="emergencyMessage">Seek immediate medical attention!</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Primary Diagnosis -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Most Likely Condition</h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h3 id="diagnosisName" class="text-primary mb-2">-</h3>
                                    <p id="diagnosisDescription" class="text-muted">-</p>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h1 id="confidenceScore" class="display-4 text-success">-</h1>
                                        <p class="mb-0">Confidence Score</p>
                                        <div class="progress mt-2">
                                            <div id="confidenceBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Treatment Plan -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-capsule"></i> Recommended Treatment Plan</h5>
                        </div>
                        <div class="card-body">
                            <div id="treatmentPlan">
                                <!-- Treatment items will be inserted here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-clipboard-check"></i> Symptoms Analyzed</h6>
                                </div>
                                <div class="card-body">
                                    <ul id="analyzedSymptoms" class="list-group list-group-flush">
                                        <!-- Symptoms list -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Self-Care Tips</h6>
                                </div>
                                <div class="card-body">
                                    <div id="selfCareTips">
                                        <!-- Tips will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-primary me-2" onclick="restartFlow()">
                            <i class="bi bi-arrow-clockwise"></i> Start New Assessment
                        </button>
                        <button class="btn btn-outline-secondary" onclick="printResults()">
                            <i class="bi bi-printer"></i> Print Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selected Count Badge -->
    <div class="selected-count">
        <span class="badge bg-primary p-3 fs-6">
            <i class="bi bi-clipboard-check"></i>
            <span id="selectedCount">0</span> symptoms selected
        </span>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let selectedSymptoms = [];
        let symptomDetails = {};
        
        // Initialize symptom options
        document.querySelectorAll('.symptom-option').forEach(option => {
            option.addEventListener('click', function() {
                const symptom = this.getAttribute('data-symptom');
                toggleSymptom(symptom, this);
            });
        });
        
        // Search functionality
        document.getElementById('addSymptomBtn').addEventListener('click', function() {
            const searchInput = document.getElementById('symptomSearch');
            const symptom = searchInput.value.trim().toLowerCase();
            
            if (symptom && !selectedSymptoms.includes(symptom)) {
                addSymptom(symptom);
                searchInput.value = '';
                document.getElementById('searchResults').innerHTML = '';
            }
        });
        
        document.getElementById('symptomSearch').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            if (query.length > 2) {
                searchSymptoms(query);
            }
        });
        
        function toggleSymptom(symptom, element) {
            if (selectedSymptoms.includes(symptom)) {
                removeSymptom(symptom);
                element.classList.remove('selected');
            } else {
                addSymptom(symptom);
                element.classList.add('selected');
            }
            updateSelectedCount();
        }
        
        function addSymptom(symptom) {
            if (!selectedSymptoms.includes(symptom)) {
                selectedSymptoms.push(symptom);
                symptomDetails[symptom] = {
                    severity: 5,
                    duration: '',
                    notes: ''
                };
                updateUI();
            }
        }
        
        function removeSymptom(symptom) {
            const index = selectedSymptoms.indexOf(symptom);
            if (index > -1) {
                selectedSymptoms.splice(index, 1);
                delete symptomDetails[symptom];
                updateUI();
            }
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedSymptoms.length;
        }
        
        function updateUI() {
            updateSelectedCount();
            
            // Update symptom details container if we're on step 2
            if (document.getElementById('step2').classList.contains('active')) {
                updateSymptomDetails();
                updateSuggestedSymptoms();
            }
        }
        
        function updateSymptomDetails() {
            const container = document.getElementById('symptomDetailsContainer');
            
            if (selectedSymptoms.length === 0) {
                container.innerHTML = '<p class="text-muted">No symptoms selected yet. Go back to Step 1.</p>';
                return;
            }
            
            let html = '';
            selectedSymptoms.forEach(symptom => {
                const details = symptomDetails[symptom];
                html += `
                <div class="symptom-category">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">${symptom.charAt(0).toUpperCase() + symptom.slice(1)}</h5>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeSymptom('${symptom}'); this.parentElement.parentElement.remove();">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label>Severity (1-10)</label>
                            <input type="range" class="form-range" min="1" max="10" value="${details.severity}" 
                                   onchange="updateSymptomDetail('${symptom}', 'severity', this.value)">
                            <div class="d-flex justify-content-between small">
                                <span>Mild</span>
                                <span id="severityValue-${symptom.replace(/\s+/g, '-')}">${details.severity}/10</span>
                                <span>Severe</span>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label>Duration</label>
                            <select class="form-select" onchange="updateSymptomDetail('${symptom}', 'duration', this.value)">
                                <option ${details.duration === '' ? 'selected' : ''}>Select duration</option>
                                <option value="hours" ${details.duration === 'hours' ? 'selected' : ''}>Hours</option>
                                <option value="days" ${details.duration === 'days' ? 'selected' : ''}>Days</option>
                                <option value="weeks" ${details.duration === 'weeks' ? 'selected' : ''}>Weeks</option>
                                <option value="months" ${details.duration === 'months' ? 'selected' : ''}>Months</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label>When did it start?</label>
                            <input type="date" class="form-control" 
                                   onchange="updateSymptomDetail('${symptom}', 'startDate', this.value)">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label>Additional details (optional)</label>
                        <textarea class="form-control" rows="2" 
                                  placeholder="Describe the symptom in more detail..."
                                  onchange="updateSymptomDetail('${symptom}', 'notes', this.value)">${details.notes || ''}</textarea>
                    </div>
                </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function updateSymptomDetail(symptom, field, value) {
            if (symptomDetails[symptom]) {
                symptomDetails[symptom][field] = value;
                
                // Update severity display
                if (field === 'severity') {
                    const displayElement = document.getElementById(`severityValue-${symptom.replace(/\s+/g, '-')}`);
                    if (displayElement) {
                        displayElement.textContent = `${value}/10`;
                    }
                }
            }
        }
        
        function searchSymptoms(query) {
            // In a real app, this would fetch from the server
            const commonSymptoms = [
                'sore throat', 'runny nose', 'sneezing', 'body aches',
                'chills', 'muscle pain', 'loss of taste', 'loss of smell',
                'mucus', 'wheezing', 'chest tightness', 'blurred vision',
                'sensitivity to light', 'abdominal pain', 'back pain',
                'joint pain', 'swelling', 'redness', 'dizziness', 'shortness of breath'
            ];
            
            const results = commonSymptoms.filter(s => s.includes(query));
            const resultsDiv = document.getElementById('searchResults');
            
            if (results.length > 0) {
                let html = '<div class="d-flex flex-wrap gap-2">';
                results.forEach(symptom => {
                    html += `<span class="badge bg-light text-dark p-2" style="cursor: pointer;" 
                             onclick="addSymptomFromSearch('${symptom}')">${symptom}</span>`;
                });
                html += '</div>';
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = '<p class="text-muted small">No matching symptoms found. Try being more specific.</p>';
            }
        }
        
        function addSymptomFromSearch(symptom) {
            if (!selectedSymptoms.includes(symptom)) {
                addSymptom(symptom);
                document.getElementById('searchResults').innerHTML = '';
                document.getElementById('symptomSearch').value = '';
                
                // If we're on step 2, refresh the details
                if (document.getElementById('step2').classList.contains('active')) {
                    updateSymptomDetails();
                    updateSuggestedSymptoms();
                }
            }
        }
        
        function updateSuggestedSymptoms() {
            const suggestionsCard = document.getElementById('suggestedSymptomsCard');
            const suggestionsDiv = document.getElementById('suggestedSymptoms');
            
            // This would come from the backend in a real app
            // For now, show some common co-occurring symptoms
            const suggestionMap = {
                'fever': ['chills', 'sweating', 'body aches'],
                'cough': ['sore throat', 'chest pain', 'shortness of breath'],
                'headache': ['blurred vision', 'nausea', 'sensitivity to light'],
                'fatigue': ['weakness', 'dizziness', 'difficulty concentrating'],
                'nausea': ['vomiting', 'loss of appetite', 'abdominal pain'],
                'chest pain': ['shortness of breath', 'dizziness', 'sweating']
            };
            
            let allSuggestions = new Set();
            selectedSymptoms.forEach(symptom => {
                if (suggestionMap[symptom]) {
                    suggestionMap[symptom].forEach(s => {
                        if (!selectedSymptoms.includes(s)) {
                            allSuggestions.add(s);
                        }
                    });
                }
            });
            
            if (allSuggestions.size > 0) {
                suggestionsCard.style.display = 'block';
                let html = '';
                allSuggestions.forEach(symptom => {
                    html += `<span class="badge bg-info text-dark p-2" style="cursor: pointer;" 
                             onclick="addSymptom('${symptom}'); updateSymptomDetails(); this.remove();">${symptom}</span>`;
                });
                suggestionsDiv.innerHTML = html;
            } else {
                suggestionsCard.style.display = 'none';
            }
        }
        
        function nextStep(step) {
            // Validate current step
            if (step === 2 && selectedSymptoms.length === 0) {
                alert('Please select at least one symptom to continue.');
                return;
            }
            
            // Hide all steps
            document.querySelectorAll('.flow-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Show target step
            document.getElementById(`step${step}`).classList.add('active');
            
            // Update UI if needed
            if (step === 2) {
                updateSymptomDetails();
                updateSuggestedSymptoms();
            }
        }
        
        function prevStep(step) {
            document.querySelectorAll('.flow-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(`step${step}`).classList.add('active');
        }
        
        async function getDiagnosis() {
            // Validate
            if (selectedSymptoms.length === 0) {
                alert('Please select at least one symptom.');
                return;
            }
            
            const age = document.getElementById('patientAge').value;
            if (!age || age < 0 || age > 120) {
                alert('Please enter a valid age (0-120).');
                return;
            }
            
            // Move to results step
            nextStep(4);
            
            // Show loading
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            
            try {
                // Prepare data
                const patientData = {
                    symptoms: selectedSymptoms,
                    symptom_details: symptomDetails,
                    age: age,
                    gender: document.getElementById('patientGender').value,
                    medical_history: document.getElementById('medicalHistory').value,
                    duration: document.getElementById('symptomDuration').value
                };
                
                // Send to backend
                const response = await fetch('/diagnose', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(patientData)
                });
                
                const data = await response.json();
                
                // Hide loading, show results
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
                
                if (data.success) {
                    // Update results
                    document.getElementById('diagnosisName').textContent = data.diagnosis || 'Unable to determine';
                    document.getElementById('confidenceScore').textContent = `${Math.round(data.confidence)}%`;
                    document.getElementById('confidenceBar').style.width = `${data.confidence}%`;
                    
                    // Add description if available
                    if (data.description) {
                        document.getElementById('diagnosisDescription').textContent = data.description;
                    }
                    
                    // Update treatment plan
                    const treatmentDiv = document.getElementById('treatmentPlan');
                    treatmentDiv.innerHTML = '';
                    if (data.treatment && Array.isArray(data.treatment)) {
                        data.treatment.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'treatment-item';
                            div.innerHTML = `<i class="bi bi-check-circle-fill text-success me-2"></i> ${item}`;
                            treatmentDiv.appendChild(div);
                        });
                    }
                    
                    // Update symptoms list
                    const symptomsList = document.getElementById('analyzedSymptoms');
                    symptomsList.innerHTML = '';
                    selectedSymptoms.forEach(symptom => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            ${symptom}
                            <span class="badge ${getSeverityClass(symptomDetails[symptom].severity)}">
                                ${symptomDetails[symptom].severity}/10
                            </span>
                        `;
                        symptomsList.appendChild(li);
                    });
                    
                    // Add self-care tips
                    const tipsDiv = document.getElementById('selfCareTips');
                    tipsDiv.innerHTML = '';
                    const tips = data.self_care || [
                        'Get plenty of rest',
                        'Stay hydrated',
                        'Monitor symptoms daily',
                        'Follow prescribed treatment'
                    ];
                    tips.forEach(tip => {
                        const p = document.createElement('p');
                        p.className = 'mb-2';
                        p.innerHTML = `<i class="bi bi-check text-success me-2"></i> ${tip}`;
                        tipsDiv.appendChild(p);
                    });
                    
                    // Check for emergency
                    if (data.emergency) {
                        document.getElementById('emergencyAlert').style.display = 'block';
                        document.getElementById('emergencyMessage').textContent = data.emergency_message || 
                            'Based on your symptoms, you should seek immediate medical attention.';
                    }
                    
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
                
            } catch (error) {
                document.getElementById('loadingSection').style.display = 'none';
                alert('Error getting diagnosis: ' + error.message);
                prevStep(3);
            }
        }
        
        function getSeverityClass(severity) {
            severity = parseInt(severity);
            if (severity <= 3) return 'bg-success';
            if (severity <= 7) return 'bg-warning text-dark';
            return 'bg-danger';
        }
        
        function restartFlow() {
            // Reset everything
            selectedSymptoms = [];
            symptomDetails = {};
            
            // Reset UI
            document.querySelectorAll('.symptom-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById('patientAge').value = '';
            document.getElementById('patientGender').selectedIndex = 0;
            document.getElementById('medicalHistory').value = '';
            document.getElementById('symptomDuration').selectedIndex = 0;
            
            // Go back to step 1
            document.querySelectorAll('.flow-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById('step1').classList.add('active');
            
            updateSelectedCount();
        }
        
        function printResults() {
            window.print();
        }
        
        // Initialize
        updateSelectedCount();
    </script>
</body>
</html>

